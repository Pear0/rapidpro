-extends "smartmin/form.html"

-load compress temba smartmin i18n

-block form-span

-block title-text
  .title-text
    %h1
      -trans "TransferTo Account"

-block summary
  -if object.is_connected_to_transferto
    -trans "Connected to TransferTo Account"
    {{transferto_account_login}}.
  -else
    -trans "No TransferTo account connected."

-block pre-form
  -if not object.is_connected_to_transferto
    -blocktrans
      Adding a TransferTo account will allow you to send airtime credit for 400+ operators in over 100 countries. Once connected
      you can transfer airtime credit within your Flows. To signup for an account, visit
    <a target='_new' href='https://www.transfer-to.com/about#contact_us'>TransferTo</a>.
    %hr

-block post-form
  -if object.is_connected_to_transferto and request.META.HTTP_X_FORMAX
    %a.btn.pull-right{style: 'margin-left: 30px', href:'{% url "airtime.airtimetransfer_list" %}'}
      -trans "Transfer Log"

    %p
      -trans "Your account is connected to the TransferTo account"
      {{transferto_account_login}}.

    %p
      -trans "If you no longer want it connected, you can"
      %a{href:'javascript:confirmTransferToDisconnect();'}
        -trans "disconnect"
      -trans "your TransferTo account. Doing so will cause the payment actions in your flows to no longer be processed."

    .disconnect-transferto.hide
      .title
        -trans "Disconnect TransferTo"
      .body
        -blocktrans
          This will disconnect your TransferTo account. Payment actions will no longer be processed. Are you sure you want to proceed?
    %a#disconnect-transferto-form.posterize{href:'{% url "orgs.org_transfer_to_account" %}?disconnect=true'}
  -else
    -trans "You can find your API Token by clicking on "
    %a{href:'https://shop.transferto.com/cgi-bin/developer_page', target:'_new'}><
      Developer
    -trans " on the TransferTo site."

-block extra-script
  :javascript
    function confirmTransferToDisconnect() {
      removalConfirmation("disconnect-transferto", "Disconnect");
    }

    function enableCurrencies(selector, multi) {
      $(selector).select2({
        selectOnBlur: false,
        multiple:multi,
        allowClear:true,
        placeholder: 'Select a currency',
        quietMillis: 200,
        minimumInputLength: 0,
        ajax: {
            url: "{% url 'orgs.org_transfer_to_account' %}",
            dataType: 'json',
            data: function (term, page, context) {
                return {
                    search: term,
                    page: page
                };
            },
            results: function (response, page, context) {
                return response;
            }
        },
        initSelection: function(element, callback) {
          var codes = $(element).val();
          if (codes !== "") {
            $.getJSON("{% url 'orgs.org_transfer_to_account' %}", {initial: codes}).done(function(data) {
              if (multi){
                callback(data.results);
              } else {
                callback(data.results[0]);
              }
            });
          }
        },
        containerCssClass: 'select2-temba-field'
      })
    }

    $(document).ready(function(){
      enableCurrencies('#id_currencies', true)
    });
